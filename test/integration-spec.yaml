# Defines spec to be run by integration-test.js

# phantomas scope helper functions
- url: "/phantomas-scope.html"
  label: "/phantomas-scope.html"
  metrics:
    jsErrors: 0
    asserts: 10

# DOM operations
- url: "/dom-operations.html"
  options:
    cookie: "bar=foo;domain=url"
  metrics:
    requests: 3
    htmlCount: 1
    htmlSize: 2094
    cssCount: 1
    cssSize: 22
    jsCount: 1
    jsSize: 29415
    domains: 1
    DOMqueries: 20
    DOMqueriesById: 7
    DOMqueriesByClassName: 1
    DOMqueriesByTagName: 9
    DOMqueriesByQuerySelectorAll: 3
    DOMinserts: 2 # "div" appended to "html" (from jQuery) and the one below
    DOMqueriesDuplicated: 2
    DOMqueriesAvoidable: 3
    DOMqueriesWithoutResults: 4

  offenders:
    DOMqueriesById:
      - { id: 'foo', node: '#document' }
      - { id: 'foo', node: '#document' }
      - { id: 'delete', node: '#document' }
      - { id: 'foo', node: '#document' }
      - { id: 'list1', node: '#document' }
      - { id: 'list2', node: '#document' }
      - { id: 'foobar', node: '#document' }
    DOMqueriesByClassName:
      - { class: 'barr', node: 'body' }
    DOMqueriesByTagName:
      - { tag: '*', node: 'div' }
      - { tag: 'script', node: 'DocumentFragment > strong[0]' }
      - { tag: 'script', node: 'DocumentFragment > strong[0]' }
      - { tag: 'strong', node: '#document' }
      - { tag: 'strong', node: '#document' }
      - { tag: 'li', node: 'body > ul#list1' }
      - { tag: 'li', node: 'body > ul#list2' }
      - { tag: 'a', node: 'div' }
      - { tag: 'a', node: 'div' }
    DOMinserts:
      - { append: 'html > div[2]', node: 'html' }
      - { append: 'body > p#foo > strong[0]', node: 'body > p#foo' }
    DOMqueriesDuplicated:
      - { query: 'id "#foo" (in #document)', count: 3 }
      - { query: 'tag name "strong" (in #document)', count: 2 }

# DOM mutations
- url: "/dom-operations.html"
  metrics:
    DOMmutationsInserts: 1 # DocumentFragment > b[0]" appended to "body > p#foo"

# DOM complexity
- url: "/dom-complexity.html"
  metrics:
    base64Count: 1
    base64Size: 43
    bodyHTMLSize: 709
    commentsSize: 85
    DOMelementsCount: 11
    DOMelementMaxDepth: 2
    DOMidDuplicated: 0
    hiddenContentSize: 373
    imagesScaledDown: 0
    imagesWithoutDimensions: 3
    hiddenImages: 3
    nodesWithInlineCSS: 1
    whiteSpacesSize: 33
  offenders:
    hiddenImages:
      - 'http://127.0.0.1:8888/static/mdn.png'
      - 'http://127.0.0.1:8888/static/blank.gif'
      - 'http://127.0.0.1:8888/static/example.svg'
    nodesWithInlineCSS:
      - { css: 'color: blue', node: 'p#foo' }

# document height
- url: "/document-height.html"
  metrics:
    documentHeight: 50000
# image scaling (issue #390)
- url: "/image-scaling.html"
  metrics:
    imagesScaledDown: 2
    imagesWithoutDimensions: 3
  offenders:
    imagesScaledDown:
      - { url: 'http://127.0.0.1:8888/static/mdn.png', naturalWidth: 600, naturalHeight: 529, imgWidth: 300, imgHeight: 265 }
      - { url: 'http://127.0.0.1:8888/static/mdn.png', naturalWidth: 600, naturalHeight: 529, imgWidth: 50, imgHeight: 50 }
# duplicated ID (issue #392)
- url: "/dom-id.html"
  metrics:
    DOMidDuplicated: 2 # foo and bar

# inline styles (#397 / #694)
- url: "/inline-css.html"
  options:
    "analyze-css": true
  metrics:
    requests: 2
    cssDuplicatedSelectors: 1
    cssParsingErrors: 1
    cssInlineStyles: 3
    cssLength: 200
    cssRules: 4
    cssImportants: 1
    DOMqueries: 0
  offenders:
    cssParsingErrors:
      - {
          url: '[inline CSS]',
          value: { message: "missing '{'", position: {
            end: { column: 2, line: 3 },
            start: { column: 2, line: 3 }
          }}
        }
    cssInlineStyles:
      - { node: 'head > style[1]' }
      - { node: 'body > style[0]' }
      - { node: 'body > style[1]' }

# analyze-css fails to parse a file (#404)
- url: "/broken-css.html"
  options:
    "analyze-css": true
  metrics:
    cssParsingErrors: 3
    cssLength: 39
    cssRules: 1

- url: "/dom-operations.html"
  options:
    "analyze-css": true
  metrics:
    cssParsingErrors: 0
    cssLength: 22
    cssRules: 1

# jQuery and events (#440 / #451)
- url: "/jquery.html"
  metrics:
    gzipRequests: 1
    jQueryVersion: "2.1.1"
    jQueryOnDOMReadyFunctions: 1
    jQueryWindowOnLoadFunctions: 1
    jQuerySizzleCalls: 1
    jQueryEventTriggers: 2
    eventsBound: 8
    eventsDispatched: 1
    eventsScrollBound: 2
  offenders:
    gzipRequests:
      - { url: 'http://127.0.0.1:8888/static/jquery-2.1.1.min.js', transferedSize: 29415, bodySize: 84245 }
    eventsDispatched:
      - { eventType: 'click', path: 'body > div#foo > span.bar' }
    eventsBound:
      - { eventType: 'load', path: 'window' }
      - { eventType: 'DOMContentLoaded', path: '#document' }
      - { eventType: 'load', path: 'window' }
      - { eventType: 'load', path: 'window' }
      - { eventType: 'click', path: 'body > div#foo > span.bar' }
      - { eventType: 'load', path: 'body > div#foo > span.bar' }
      - { eventType: 'scroll', path: '#document' }
      - { eventType: 'scroll', path: 'window' }
    eventsScrollBound:
      - { element: '#document' }
      - { element: 'window' }
    jQueryVersionsLoaded:
      - version: "2.1.1"
        url: 'http://127.0.0.1:8888/static/jquery-2.1.1.min.js' 
    jQueryWindowOnLoadFunctions:
      - http://127.0.0.1:8888/jquery.html:49:13
    jQueryEventTriggers:
      - { type: 'click', element: 'body > div#foo > span.bar' }
      - { element: '#document',  type: 'ready' }
    jQuerySizzleCalls: 
      - { selector: '#foo .bar', element: '#document' }
    jQueryDOMReads:
      - { functionName: 'css', arguments: '["color"]', contextPath: 'body > div#foo > span.bar' }
    jQueryDOMWrites:
     - { functionName: 'css', arguments: '[{"color":"red","background":"green"}]', contextPath: 'body > div#foo > span.bar' }
     - { functionName: 'css', arguments: '[{"background-color":"blue"}]', contextPath: 'body > div#foo' }
     - { functionName: 'css', arguments: '[{"background-color":"blue"}]', contextPath: 'body > div#foo' }
    jQueryDOMWriteReadSwitches:
      - { functionName: 'css', arguments: '["color"]', contextPath: 'body > div#foo > span.bar' }

# multiple jQuery "instances" (issue #435)
- url: "/jquery-multiple.html"
  metrics:
    requests: 3
    jsCount: 2
    domains: 2
    maxRequestsPerDomain: 2
    jQueryVersion: "1.11.1" # the last loaded version
    jQueryVersionsLoaded: 2
    jQueryOnDOMReadyFunctions: 1
  offenders:
    jQueryVersionsLoaded:
      - { version: "2.1.1", url: 'http://127.0.0.1:8888/static/jquery-2.1.1.min.js' }
      - { version: "1.11.1", url: 'http://code.jquery.com/jquery-1.11.1.js' }
    globalVariables: [ 'jQuery', '$' ]
    domains:
      - { domain: '127.0.0.1', requests: 2 }
      - { domain: 'code.jquery.com', requests: 1 }

# --no-externals handling (issue #535)
- url: "/jquery-multiple.html"
  label: "/jquery-multiple.html (with --no-externals)"
  options:
    "no-externals": true
  metrics:
    requests: 2
    jsCount: 1
    blockedRequests: 1
    domains: 1
    jsErrors: 0
    jQueryVersion: '2.1.1'
  offenders:
    blockedRequests:
      - 'http://code.jquery.com/jquery-1.11.1.js'
# accept main domain in allow-domains
- url: "/jquery-multiple.html"
  label: "/jquery-multiple.html (with --allow-domain)"
  options:
    "no-externals": true
    "allow-domain": "code.jquery.com"
  metrics:
    requests: 3
    jsCount: 2
    blockedRequests: 0
    jQueryVersion: '1.11.1'
# jQuery read & write operations (issue #436)
- url: "/jquery-reads-writes.html"
  metrics:
    jQueryDOMReads: 5
    jQueryDOMWrites: 20
    jQueryDOMWriteReadSwitches: 4
# jQuery module should not throw any error when run agains an old version (issue #478)
- url: "/jquery-old-version.html"
  metrics:
    jsErrors: 0
    jQueryVersion: "1.4.4"
    jQuerySizzleCalls: 0
    jQueryEventTriggers: 0
# --wait-for-selector
#- url: "/"
#  label: "/ (--wait-for-selector)"
#  options:
#    timeout: 1
#    'wait-for-selector': "#foo"
#  metrics:
#    DOMqueries: 0 # no queries should be reported despite DOM being polled by waitForSelector module
#  exitCode: 252 # timeout
# --wait-for-selector (issue #512)
#- url: "/wait-for-selector.html"
#  options:
#    timeout: 10
#    'wait-for-selector': ".bar:nth-child(4):last-child"
#  metrics:
#    DOMelementsCount: 4
# --wait-for-event (issue #453)
#- url: "/wait-for-event.html"
#  options:
#    timeout: 4
#    'wait-for-event': "done"
#  metrics:
#    testFooBar: 123 # a metric set just before event trigger

# requests to (#438 / #486)
- url: "/timing.html"
  metrics:
    requests: 4
    requestsToDomContentLoaded: 3
    domainsToDomContentLoaded: 2
    requestsToDomComplete: 3
    domainsToDomComplete: 2
  offenders:
    domainsToDomContentLoaded:
      - { domain: '127.0.0.1', requests: 2 }
      - { domain: 'code.jquery.com', requests: 1 }
    domainsToDomComplete:
      - { domain: '127.0.0.1', requests: 2 }
      - { domain: 'code.jquery.com', requests: 1 }
  options:
    "wait-for-network-idle": true

# JS bottlenecks (#467)
- url: "/bottlenecks.html"
  label: "/bottlenecks.html (--spy-eval)"
  options:
    "spy-eval": true
  metrics:
    documentWriteCalls: 1
    evalCalls: 2 # via eval() and setTimeout()
  offenders:
    documentWriteCalls:
      - { message: 'document.write() used', caller: 'http://127.0.0.1:8888/bottlenecks.html:11:11' }
    evalCalls:
      - { message: 'eval() called directly', caller: 'http://127.0.0.1:8888/bottlenecks.html:8:2' }
      - { message: 'eval() called via setTimeout("foo()")', caller: 'http://127.0.0.1:8888/bottlenecks.html:9:2' }

- url: "/bottlenecks.html"
  metrics:
    documentWriteCalls: 1
    evalCalls: 1 # via setTimeout() only
  offenders:
    documentWriteCalls:
      - { message: 'document.write() used', caller: 'http://127.0.0.1:8888/bottlenecks.html:11:11' }
    evalCalls:
      - { message: 'eval() called via setTimeout("foo()")', caller: 'http://127.0.0.1:8888/bottlenecks.html:9:2' }
# stop-at-onload (#513)
- url: "/after-onload.html"
  label: "/after-onload.html"
  metrics:
    imageCount: 1
    requests: 2
- url: "/after-onload.html"
  label: "/after-onload.html (with --wait-for-network-idle)"
  options:
    "wait-for-network-idle": true
  metrics:
    imageCount: 2
    requests: 3
# lazy-loadable-images.html (#494)
- url: "/lazy-loadable-images.html"
  metrics:
    lazyLoadableImagesBelowTheFold: 2
  offenders:
    lazyLoadableImagesBelowTheFold:
      - { url: 'http://127.0.0.1:8888/static/blank.gif', node: 'body > img#dot', offset: 900 }
      - { url: 'http://127.0.0.1:8888/static/example.svg', node: 'body > footer[2] > img[3]', offset: 1526 }
# JS globals (#482)
- url: "/js-globals.html"
  metrics:
    globalVariables: 3
    globalVariablesFalsy: 1
    jsErrors: 0
  offenders:
    globalVariables: [ 'a_global', 'falsy', 'foo' ]
    globalVariablesFalsy:
      - { name: 'falsy', value: false }
# JS redirects (#550)
- url: "/js-redirect.html"
  metrics:
    requests: 2
    htmlCount: 2
    jsErrors: 0
  options:
    "wait-for-network-idle": true

# AJAX requests (#622)
- url: "/jquery-ajax.html"
  metrics:
    ajaxRequests: 3
    postRequests: 1
  offenders:
    ajaxRequests:
      - { url: '/static/style.css', method: 'POST' }
      - { url: '/static/broken.css', method: 'GET' }
      - { url: '/static/foo', method: 'GET' }
    postRequests:
      - 'http://127.0.0.1:8888/static/style.css'

# multiple cookies (#597)
- url: "/cookies.html"
  options:
    "cookie": "bar=foo;path=/"
  metrics:
    cookiesRaw: "bar=foo"
- url: "/cookies.html"
  options:
    "cookie": "bar=foo;path=/|test=42"
  metrics:
    cookiesRaw: "bar=foo; test=42"
# local storage (#710)
- url: "/local-storage.html"
  metrics:
    localStorageEntries: 2
  offenders:
    localStorageEntries: ['foo', 'test']
# JS errors
- url: "/js-errors.html"
  metrics:
    requests: 2
    jsErrors: 1
# console.log() calls
- url: "/console-log.html"
  metrics:
    consoleMessages: 2

# headers
- url: "/headers.html"
  metrics:
    requests: 2
    headersCount: 20
    headersSentCount: 4
    headersRecvCount: 16
    headersRecvSize: 578
    headersBiggerThanContent: 1
  offenders:
    headersBiggerThanContent:
     - { url: 'http://127.0.0.1:8888/static/blank.gif', contentSize: 43, headersSize: 287 }

# caching
- url: "/caching.html"
  metrics:
    requests: 2
    cachingTooShort: 1
  offenders:
    cachingTooShort:
     - { url: 'http://127.0.0.1:8888/static/mdn.png', ttl: 84600 }

# requestsStats
- url: "/headers.html"
  metrics:
    requests: 2
    bodySize: 1065
    contentLength: 1065 # these are equal as no gzip compression took place
    smallestResponse: 330  # headers + body size
    biggestResponse: 1313
  offenders:
    requests:
      - { url: 'http://127.0.0.1:8888/headers.html', type: 'html', size: 1313 }
      - { url: 'http://127.0.0.1:8888/static/blank.gif', type: 'image', size: 330 }
    smallestResponse:
      - { url: 'http://127.0.0.1:8888/static/blank.gif', size: 330 }
    biggestResponse:
      - { url: 'http://127.0.0.1:8888/headers.html', size: 1313 }

# iframes
- url: "/iframe.html"
  metrics:
    requests: 5  # include requests for iframe and its content
    iframesCount: 1
  offenders:
    iframesCount:
     - { element: 'body > iframe[1]', url: 'http://127.0.0.1:8888/image-scaling.html' }
